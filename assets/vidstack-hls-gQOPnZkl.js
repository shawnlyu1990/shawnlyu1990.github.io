var q=t=>{throw TypeError(t)};var C=(t,i,e)=>i.has(t)||q("Cannot "+e);var s=(t,i,e)=>(C(t,i,"read from private field"),e?e.call(t):i.get(t)),p=(t,i,e)=>i.has(t)?q("Cannot add the same private member more than once"):i instanceof WeakSet?i.add(t):i.set(t,e),u=(t,i,e,h)=>(C(t,i,"write to private field"),h?h.call(t,e):i.set(t,e),e),o=(t,i,e)=>(C(t,i,"access private method"),e);import{f as nt,L as A,g as ht,A as D,b as N,s as O,F as at,_ as k,e as ot,x as lt,i as V,c as _,T as dt,m as F,o as ct,S as ut,E as pt,r as ft}from"./app-n5JhKmDN.js";import{VideoProvider as gt}from"./vidstack-video-h9tD2Aca.js";import"./vidstack-EIUG4XP7-CxwEuMuu.js";var yt=t=>ft(t),m,a,r,T,w,n,S,M,U,B,K,W,X,Y,z,G,J,Q,Z,tt,H,bt=(H=class{constructor(t,i){p(this,n);p(this,m);p(this,a);p(this,r);p(this,T);p(this,w);u(this,r,null),u(this,T,null),this.config={},u(this,w,new Set),u(this,m,t),u(this,a,i)}get instance(){return s(this,r)}setup(t){let{streamType:i}=s(this,a).$state,e=D(i).includes("live"),h=D(i).includes("ll-");u(this,r,new t({lowLatencyMode:h,backBufferLength:h?4:e?8:void 0,renderTextTracksNatively:!1,...this.config}));let d=o(this,n,B).bind(this);for(let l of Object.values(t.Events))s(this,r).on(l,d);s(this,r).on(t.Events.ERROR,o(this,n,G).bind(this));for(let l of s(this,w))l(s(this,r));s(this,a).player.dispatch("hls-instance",{detail:s(this,r)}),s(this,r).attachMedia(s(this,m)),s(this,r).on(t.Events.AUDIO_TRACK_SWITCHED,o(this,n,X).bind(this)),s(this,r).on(t.Events.LEVEL_SWITCHED,o(this,n,Y).bind(this)),s(this,r).on(t.Events.LEVEL_LOADED,o(this,n,z).bind(this)),s(this,r).on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,o(this,n,K).bind(this)),s(this,r).on(t.Events.CUES_PARSED,o(this,n,W).bind(this)),s(this,a).qualities[N.enableAuto]=o(this,n,Q).bind(this),O(s(this,a).qualities,"change",o(this,n,Z).bind(this)),O(s(this,a).audioTracks,"change",o(this,n,tt).bind(this)),u(this,T,at(o(this,n,M).bind(this)))}onInstance(t){return s(this,w).add(t),()=>s(this,w).delete(t)}loadSource(t){var i;A(t.src)&&((i=s(this,r))==null||i.loadSource(t.src))}destroy(){var t,i;(t=s(this,r))==null||t.destroy(),u(this,r,null),(i=s(this,T))==null||i.call(this),u(this,T,null)}},m=new WeakMap,a=new WeakMap,r=new WeakMap,T=new WeakMap,w=new WeakMap,n=new WeakSet,S=function(t,i){return new k(yt(t),{detail:i})},M=function(){if(!s(this,a).$state.live())return;let t=new ot(o(this,n,U).bind(this));return t.start(),t.stop.bind(t)},U=function(){var t;s(this,a).$state.liveSyncPosition.set(((t=s(this,r))==null?void 0:t.liveSyncPosition)??1/0)},B=function(t,i){var e;(e=s(this,a).player)==null||e.dispatch(o(this,n,S).call(this,t,i))},K=function(t,i){let e=o(this,n,S).call(this,t,i),h=-1;for(let d=0;d<i.tracks.length;d++){let l=i.tracks[d],c=l.subtitleTrack??l.closedCaptions,f=new lt({id:`hls-${l.kind}-${d}`,src:c==null?void 0:c.url,label:l.label,language:c==null?void 0:c.lang,kind:l.kind,default:l.default});f[V.readyState]=2,f[V.onModeChange]=()=>{f.mode==="showing"?(s(this,r).subtitleTrack=d,h=d):h===d&&(s(this,r).subtitleTrack=-1,h=-1)},s(this,a).textTracks.add(f,e)}},W=function(t,i){var l;let e=(l=s(this,r))==null?void 0:l.subtitleTrack,h=s(this,a).textTracks.getById(`hls-${i.type}-${e}`);if(!h)return;let d=o(this,n,S).call(this,t,i);for(let c of i.cues)c.positionAlign="auto",h.addCue(c,d)},X=function(t,i){let e=s(this,a).audioTracks[i.id];if(e){let h=o(this,n,S).call(this,t,i);s(this,a).audioTracks[_.select](e,!0,h)}},Y=function(t,i){let e=s(this,a).qualities[i.level];if(e){let h=o(this,n,S).call(this,t,i);s(this,a).qualities[_.select](e,!0,h)}},z=function(t,i){var R;if(s(this,a).$state.canPlay())return;let{type:e,live:h,totalduration:d,targetduration:l}=i.details,c=o(this,n,S).call(this,t,i);s(this,a).notify("stream-type-change",h?e==="EVENT"&&Number.isFinite(d)&&l>=10?"live:dvr":"live":"on-demand",c),s(this,a).notify("duration-change",d,c);let f=s(this,r).media;s(this,r).currentLevel===-1&&s(this,a).qualities[N.setAuto](!0,c);for(let y of s(this,r).audioTracks){let P={id:y.id.toString(),label:y.name,language:y.lang||"",kind:"main"};s(this,a).audioTracks[_.add](P,c)}for(let y of s(this,r).levels){let P={id:((R=y.id)==null?void 0:R.toString())??y.height+"p",width:y.width,height:y.height,codec:y.codecSet,bitrate:y.bitrate};s(this,a).qualities[_.add](P,c)}f.dispatchEvent(new k("canplay",{trigger:c}))},G=function(t,i){var e;if(i.fatal)switch(i.type){case"mediaError":(e=s(this,r))==null||e.recoverMediaError();break;default:o(this,n,J).call(this,i.error);break}},J=function(t){s(this,a).notify("error",{message:t.message,code:1,error:t})},Q=function(){s(this,r)&&(s(this,r).currentLevel=-1)},Z=function(){let{qualities:t}=s(this,a);!s(this,r)||t.auto||(s(this,r)[t.switch+"Level"]=t.selectedIndex,dt&&(s(this,m).currentTime=s(this,m).currentTime))},tt=function(){let{audioTracks:t}=s(this,a);s(this,r)&&s(this,r).audioTrack!==t.selectedIndex&&(s(this,r).audioTrack=t.selectedIndex)},H),L,b,I,v,it,st,et,rt,j,vt=(j=class{constructor(t,i,e){p(this,v);p(this,L);p(this,b);p(this,I);u(this,L,t),u(this,b,i),u(this,I,e),o(this,v,it).call(this)}},L=new WeakMap,b=new WeakMap,I=new WeakMap,v=new WeakSet,it=async function(){let t={onLoadStart:o(this,v,st).bind(this),onLoaded:o(this,v,et).bind(this),onLoadError:o(this,v,rt).bind(this)},i=await St(s(this,L),t);return F(i)&&!A(s(this,L))&&(i=await Et(s(this,L),t)),i?i.isSupported()?i:(s(this,b).player.dispatch(new k("hls-unsupported")),s(this,b).notify("error",{message:"[vidstack] `hls.js` is not supported in this environment",code:4}),null):null},st=function(){s(this,b).player.dispatch(new k("hls-lib-load-start"))},et=function(t){s(this,b).player.dispatch(new k("hls-lib-loaded",{detail:t})),s(this,I).call(this,t)},rt=function(t){let i=ct(t);s(this,b).player.dispatch(new k("hls-lib-load-error",{detail:i})),s(this,b).notify("error",{message:i.message,code:4,error:i})},j);async function Et(t,i={}){var e,h,d,l,c;if(!F(t)){if((e=i.onLoadStart)==null||e.call(i),t.prototype&&t.prototype!==Function)return(h=i.onLoaded)==null||h.call(i,t),t;try{let f=(d=await t())==null?void 0:d.default;if(f&&f.isSupported)(l=i.onLoaded)==null||l.call(i,f);else throw Error("");return f}catch(f){(c=i.onLoadError)==null||c.call(i,f)}}}async function St(t,i={}){var e,h,d;if(A(t)){(e=i.onLoadStart)==null||e.call(i);try{if(await ut(t),!pt(window.Hls))throw Error("");let l=window.Hls;return(h=i.onLoaded)==null||h.call(i,l),l}catch(l){(d=i.onLoadError)==null||d.call(i,l)}}}var mt="https://cdn.jsdelivr.net",$,g,E,x,$t=(x=class extends gt{constructor(){super(...arguments);p(this,$);p(this,g);p(this,E);this.$$PROVIDER_TYPE="HLS",u(this,$,null),u(this,g,new bt(this.video,this.ctx)),u(this,E,`${mt}/npm/hls.js@^1.5.0/dist/hls.min.js`)}get ctor(){return s(this,$)}get instance(){return s(this,g).instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return s(this,g).config}set config(e){s(this,g).config=e}get library(){return s(this,E)}set library(e){u(this,E,e)}preconnect(){A(s(this,E))&&ht(s(this,E))}setup(){super.setup(),new vt(s(this,E),this.ctx,e=>{u(this,$,e),s(this,g).setup(e),this.ctx.notify("provider-setup",this);let h=D(this.ctx.$state.source);h&&this.loadSource(h)})}async loadSource(e,h){if(!A(e.src)){this.removeSource();return}this.media.preload=h||"",this.appendSource(e,"application/x-mpegurl"),s(this,g).loadSource(e),this.currentSrc=e}onInstance(e){let h=s(this,g).instance;return h&&e(h),s(this,g).onInstance(e)}destroy(){s(this,g).destroy()}},$=new WeakMap,g=new WeakMap,E=new WeakMap,x.supported=nt(),x);export{$t as HLSProvider};
