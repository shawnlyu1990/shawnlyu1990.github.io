import{_ as s,c as a,d as n,o as l}from"./app-BCUXlOmv.js";const t={};function e(h,i){return l(),a("div",null,i[0]||(i[0]=[n(`<div class="hint-container important"><p class="hint-container-title">重要</p><p>由于作者水平有限，以下内容仅在我的环境中配置成功，这里提供思路供您参考。</p><p>因为每个环境各有差异，如果有些配置在您的环境中出现了一些异常错误，请您自行排查解决。</p></div><h2 id="_1-安装ntp服务" tabindex="-1"><a class="header-anchor" href="#_1-安装ntp服务"><span>1. 安装ntp服务</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">yum</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -y</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntp</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_2-设置时区" tabindex="-1"><a class="header-anchor" href="#_2-设置时区"><span>2. 设置时区</span></a></h2><h3 id="_2-1-查看系统提供的时区信息" tabindex="-1"><a class="header-anchor" href="#_2-1-查看系统提供的时区信息"><span>2.1. 查看系统提供的时区信息</span></a></h3><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# ls -F /usr/share/zoneinfo/</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Africa/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      Brazil/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Egypt</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    GB-Eire</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    HST</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">          Japan</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      Navajo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    posixrules</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Turkey</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     zone.tab</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">America/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Canada/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Eire</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     GMT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        Iceland</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      Kwajalein</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  NZ</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        PRC</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         UCT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        Zulu</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Antarctica/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  CET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      EST</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      GMT0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       Indian/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      Libya</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      NZ-CHAT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   PST8PDT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Universal</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Arctic/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      Chile/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   EST5EDT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  GMT-0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      Iran</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         MET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        Pacific/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  right/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      US/</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Asia/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        CST6CDT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Etc/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     GMT+0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      iso3166.tab</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Mexico/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    Poland</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    ROC</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         UTC</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Atlantic/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    Cuba</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">     Europe/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Greenwich</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Israel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       MST</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">        Portugal</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  ROK</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">         WET</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Australia/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   EET</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      GB</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">       Hongkong</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   Jamaica</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">      MST7MDT</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    posix/</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">    Singapore</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">   W-SU</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这里面可以找到自己所在城市的 <code>time zone</code> 文件，例如北京时间就是这个文件</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# ls -F /usr/share/zoneinfo/Asia/Shanghai </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">/usr/share/zoneinfo/Asia/Shanghai</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>查看每个<code>time zone</code>当前的时间可以使用<code>zdump</code>命令</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# zdump Japan</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Japan</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">  Thu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 12:01:34</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2017</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> JST</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>若要修改系统时区可以使用如下方法</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# rm -rf /etc/localtime</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# ln -sf /usr/share/zoneinfo/posix/Asia/Shanghai /etc/localtime</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# ll /etc/localtime </span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lrwxrwxrwx.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> root</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 35</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  2017</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/localtime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> -&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">../usr/share/zoneinfo/Asia/Shanghai</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# date</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Thu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:05:24</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> CST</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2017</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-同步硬件时间和系统时间" tabindex="-1"><a class="header-anchor" href="#_3-同步硬件时间和系统时间"><span>3. 同步硬件时间和系统时间</span></a></h2><p>首先明确一个概念：<br> 在计算机上有两个时钟，一个是硬件时钟（RTC），一个是系统时钟（System Clock）</p><p>硬件时钟（RTC）是指嵌在主板上的特殊的电路，他的存在就是平时我们关机后还可以计算时间的原因。</p><p>系统时钟（System Clock）是操作系统的kernel用来计算时间的时钟，它从1970年1月1日00:00:00 UTC时间到目前为止秒数总和的值 在Linux下系统时间在开机的时候会和硬件时间同步(synchronization),之后也就各自独立运行了</p><p>既然两个时钟独立运行，时间久了就会产生误差。</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# date</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Thu</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:13:04</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> CST</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2017</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# hwclock --show</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">2017-02-16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:13:05.679891+8:00</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 <code>hwclock --show</code> 命令我们可以查看机器上的硬件时间(always in local time zone), 我们可以看到它和系统时间还是有一定的误差的, 那么我们就需要把他们同步</p><p>如果我们想要把硬件时间设置成系统时间我们可以运行以下命令</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# hwclock --hctosys</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>反之，我们也可以把系统时间设置成硬件时间</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# hwclock --systohc</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>那么如果想设置硬件时间我们可以开机的时候在BIOS里设定，也可以用 <code>hwclock</code> 命令</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# hwclock --set </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">--date</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;mm/dd/yy hh:mm:ss&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果想要修改系统时间那么用date命令就最简单了</p><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# date -s </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;dd/mm/yyyy hh:mm:ss&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h2 id="_4-修改-ntp-conf-的配置" tabindex="-1"><a class="header-anchor" href="#_4-修改-ntp-conf-的配置"><span>4. 修改 ntp.conf 的配置</span></a></h2><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">vim</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /etc/ntp.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>配置示例：</p><div class="language-ssh-config line-numbers-mode" data-highlighter="shiki" data-ext="ssh-config" data-title="/etc/ntp.conf" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># For more information about this file, see the man pages</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 将自己主机的bios芯片震荡频率与上层的Time server频率比较，将误差记录在这个文件里</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 注意:  driftfile 后面接的文件需要使用完整的路径文件名，不能是链接文件，并且文件的权限需要设定成 ntpd守护进程可以写入。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 格式：driftfile 文件名</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">driftfile /var/lib/ntp/drift</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Permit time synchronization with our time source, but do not</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># permit the source to query or modify the service on this system.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 格式：restrict [IP]  mask [netmask_IP] [parameter]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Parameter 的参数主要如下：</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ignore :拒绝所有类型的NTP联机。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># nomodify: 客户端不能使用ntpc 与ntpq 这两个程序来修改服务器的时间参数，但客户端可透过这部主机来进行网络校时；</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># noquery:客户端不能够使用ntpc 与ntpq 等指令来查询时间服务器，不提供NTP的网络校时。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># notrap:不提供trap 这个运程事件登入的功能。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># notrust:拒绝没有认证的客户端。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Kod:kod技术可以阻止“Kiss of Death “包对服务器的破坏。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Nopeer:不与其他同一层的NTP服务器进行时间同步。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 如果没有在parameter的地方加上任何参数的话，那么表示这个ip或网络不受任何限制</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 表示默认拒绝所有IP的时间同步</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#restrict default nomodify notrap nopeer noquery</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 允许任何ip的客户机都可以进行时间同步</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">restrict default nomodify</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Permit all access over the loopback interface.  This could</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># be tightened as well, but to do so would effect some of</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># the administrative functions.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 允许本机环回地址可以进行时间同步</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">restrict </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">127.0.0.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">restrict ::</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Hosts on local network are less restricted.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 允许192.168.159.0/24网段的客户机都可以进行时间同步</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">restrict </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">192.168.159.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> mask </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">255.255.255.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nomodify notrap</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Use public servers from the pool.ntp.org project.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 利用server 设定上层NTP服务器</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 格式：server [IP or hostname] [prefer]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># perfer:表示优先级最高</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># burst ：当一个运程NTP服务器可用时，向它发送一系列的并发包进行检测。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># iburst ：当一个运程NTP服务器不可用时，向它发送一系列的并发包进行检测。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 注：默认情况小15分钟后才会与上层NTP服务器进行时间校对。</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">server </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">210.72.145.44</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> prefer</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">server time1.aliyun.com iburst</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">server time2.aliyun.com iburst</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">server time3.aliyun.com iburst</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">server time4.aliyun.com iburst</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 设置本地服务器为根时间服务器</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">server </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">127.127.1.0</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 这行是时间服务器的层次。设为0则为顶级，如果要向别的NTP服务器更新时间，请不要把它设为0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">fudge </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">127.127.1.0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> stratum </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#broadcast 192.168.1.255 autokey	# broadcast server</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#broadcastclient			# broadcast client</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#broadcast 224.0.1.1 autokey		# multicast server</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#multicastclient 224.0.1.1		# multicast client</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#manycastserver 239.255.254.254		# manycast server</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#manycastclient 239.255.254.254 autokey # manycast client</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Enable public key cryptography.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#crypto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">includefile /etc/ntp/crypto/pw</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Key file containing the keys and key identifiers used when operating</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># with symmetric key cryptography. </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 认证可以使用此时间源的客户端</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">keys /etc/ntp/keys</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Specify the key identifiers which are trusted.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#trustedkey 4 8 42</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Specify the key identifier to use with the ntpdc utility.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#requestkey 8</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Specify the key identifier to use with the ntpq utility.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#controlkey 8</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Enable writing of statistics records.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#statistics clockstats cryptostats loopstats peerstats</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Disable the monitoring facility to prevent amplification attacks using ntpdc</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># monlist command when default restrict does not include the noquery flag. See</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># CVE-2013-5211 for more details.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Note: Monitoring will not be disabled with the limited restriction flag.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 防御NTP放大攻击和NTP反射</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">disable monitor</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-启动ntpd服务-并配置开机启动" tabindex="-1"><a class="header-anchor" href="#_5-启动ntpd服务-并配置开机启动"><span>5. 启动ntpd服务，并配置开机启动</span></a></h2><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# systemctl restart ntpd</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# systemctl enable ntpd</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[root@localhost ~]# systemctl status ntpd</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">●</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd.service</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> -</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Network</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Time</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Service</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">   Loaded:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> loaded</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (/usr/lib/systemd/system/ntpd.service; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">enabled</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">vendor</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> preset:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> disabled</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">   Active:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> active</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (running) since Thu 2017-02-16 11:36:29 CST; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">12s</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ago</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Main</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> PID:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2819</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (ntpd)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    Tasks:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (limit: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">19660</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">   CGroup:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /system.slice/ntpd.service</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">           └─2819</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /usr/sbin/ntpd</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntp:ntp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -g</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Listen</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> normally</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ens34</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.139.135</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UDP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 123</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Listen</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> normally</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 5</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> virbr0</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 192.168.122.1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UDP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 123</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Listen</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> normally</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 6</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ens33</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> fe80::20c:29ff:febf:9bc9</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UDP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 123</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Listen</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> normally</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 7</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> lo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ::1</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UDP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 123</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Listen</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> normally</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 8</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ens34</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> fe80::15cc:96ee:f841:b516</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> UDP</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 123</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> Listening</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> routing</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> socket</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> on</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> fd</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> #25 for interface updates</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0.0.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> c016</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 06</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> restart</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0.0.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> c012</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 02</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> freq_set</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> kernel</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.000</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> PPM</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:29</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0.0.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> c011</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 01</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> freq_not_set</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Feb</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> 11:36:31</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> admin.example.local</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpd[2819]:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0.0.0.0</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> c614</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 04</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> freq_mode</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-查看ntp服务运行状况" tabindex="-1"><a class="header-anchor" href="#_6-查看ntp服务运行状况"><span>6. 查看ntp服务运行状况</span></a></h2><div class="language-shell line-numbers-mode" data-highlighter="shiki" data-ext="shell" data-title="shell" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">watch</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> ntpq</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>各列的释义：</p><table><thead><tr><th style="text-align:center;">列值</th><th>释义</th></tr></thead><tbody><tr><td style="text-align:center;">remote</td><td>它指的就是本地机器所连接的远程NTP服务器</td></tr><tr><td style="text-align:center;">refid</td><td>它指的是给远程服务器(e.g. 193.60.199.75)提供时间同步的服务器</td></tr><tr><td style="text-align:center;">st</td><td>远程服务器的层级别（stratum）. 由于NTP是层型结构,有顶端的服务器,多层的Relay Server再到客户端. 所以服务器从高到低级别可以设定为1-16. 为了减缓负荷和网络堵塞,原则上应该避免直接连接到级别为1的服务器的.</td></tr><tr><td style="text-align:center;">t</td><td>这个.....我也不知道啥意思<sup>_</sup></td></tr><tr><td style="text-align:center;">when</td><td>我个人把它理解为一个计时器用来告诉我们还有多久本地机器就需要和远程服务器进行一次时间同步</td></tr><tr><td style="text-align:center;">poll</td><td>本地机和远程服务器多少时间进行一次同步(单位为秒). 在一开始运行NTP的时候这个poll值会比较小,那样和服务器同步的频率也就增加了,可以尽快调整到正确的时间范围.之后poll值会逐渐增大,同步的频率也就会相应减小</td></tr><tr><td style="text-align:center;">reach</td><td>这是一个八进制值,用来测试能否和服务器连接.每成功连接一次它的值就会增加</td></tr><tr><td style="text-align:center;">delay</td><td>从本地机发送同步要求到服务器的round trip time</td></tr><tr><td style="text-align:center;">offset</td><td>这是个最关键的值, 它告诉了我们本地机和服务器之间的时间差别.offset越接近于0,我们就和服务器的时间越接近</td></tr><tr><td style="text-align:center;">jitter</td><td>这是一个用来做统计的值. 它统计了在特定个连续的连接数里offset的分布情况. 简单地说这个数值的绝对值越小我们和服务器的时间就越精确</td></tr></tbody></table><p>在这里会发现两个问题：</p><ol><li>我们连接的是 &lt;<a href="http://0.fedora.pool.ntp.org" target="_blank" rel="noopener noreferrer">0.fedora.pool.ntp.org</a>&gt; 为什么和 remote server 不一样?</li><li>那个最前面的<code>+</code>和<code>*</code>都是什么意思呢?</li></ol><p>第一个问题不难理解，因为NTP提供给我们的是一个 cluster server 所以每次连接的得到的服务器都有可能是不一样。同样这也告诉我们了在指定 NTP Server 的时候应该使用 hostname 而不是 IP。</p><p>第二个问题和第一个相关，既然有这么多的服务器就是为了在发生问题的时候其他的服务器还可以正常地给我们提供服务.那么如何知道这些服务器的状态呢? 这就是第一个记号会告诉我们的信息</p><table><thead><tr><th style="text-align:center;">标记</th><th>释义</th></tr></thead><tbody><tr><td style="text-align:center;">*</td><td>它告诉我们远端的服务器已经被确认为我们的主 NTP Server，我们系统的时间将由这台机器所提供</td></tr><tr><td style="text-align:center;">+</td><td>它将作为辅助的 NTP Server 和带有 <code>*</code> 号的服务器一起为我们提供同步服务. 当 <code>*</code> 号服务器不可用时它就可以接管</td></tr><tr><td style="text-align:center;">-</td><td>远程服务器被 clustering algorithm 认为是不合格的 NTP Server</td></tr><tr><td style="text-align:center;">x</td><td>远程服务器不可用</td></tr></tbody></table>`,42)]))}const p=s(t,[["render",e],["__file","2017-02-17-Fedora25部署服务-NTP.html.vue"]]),d=JSON.parse('{"path":"/posts/Blogs/Linux/%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/2017-02-17-Fedora25%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1-NTP.html","title":"Fedora 25 部署服务 - NTP","lang":"zh-CN","frontmatter":{"title":"Fedora 25 部署服务 - NTP","shortTitle":"Fedora 部署服务 - NTP","description":"重要 由于作者水平有限，以下内容仅在我的环境中配置成功，这里提供思路供您参考。 因为每个环境各有差异，如果有些配置在您的环境中出现了一些异常错误，请您自行排查解决。 1. 安装ntp服务 2. 设置时区 2.1. 查看系统提供的时区信息 在这里面可以找到自己所在城市的 time zone 文件，例如北京时间就是这个文件 查看每个time zone当前的...","icon":"NTP-Server","author":"昌霖学长","isOriginal":null,"date":"2017-02-17T00:00:00.000Z","categories":["Linux","服务部署"],"tags":["NTP"],"license":"MIT","sticky":false,"star":false,"article":true,"timeline":true,"comment":false,"head":[["meta",{"property":"og:url","content":"https://shawnlyu1990.github.io/posts/Blogs/Linux/%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2/2017-02-17-Fedora25%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1-NTP.html"}],["meta",{"property":"og:site_name","content":"知识杂货铺"}],["meta",{"property":"og:title","content":"Fedora 25 部署服务 - NTP"}],["meta",{"property":"og:description","content":"重要 由于作者水平有限，以下内容仅在我的环境中配置成功，这里提供思路供您参考。 因为每个环境各有差异，如果有些配置在您的环境中出现了一些异常错误，请您自行排查解决。 1. 安装ntp服务 2. 设置时区 2.1. 查看系统提供的时区信息 在这里面可以找到自己所在城市的 time zone 文件，例如北京时间就是这个文件 查看每个time zone当前的..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-01-26T06:49:22.000Z"}],["meta",{"property":"article:author","content":"昌霖学长"}],["meta",{"property":"article:tag","content":"NTP"}],["meta",{"property":"article:published_time","content":"2017-02-17T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-01-26T06:49:22.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Fedora 25 部署服务 - NTP\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2017-02-17T00:00:00.000Z\\",\\"dateModified\\":\\"2025-01-26T06:49:22.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"昌霖学长\\"}]}"]]},"headers":[{"level":2,"title":"1. 安装ntp服务","slug":"_1-安装ntp服务","link":"#_1-安装ntp服务","children":[]},{"level":2,"title":"2. 设置时区","slug":"_2-设置时区","link":"#_2-设置时区","children":[{"level":3,"title":"2.1. 查看系统提供的时区信息","slug":"_2-1-查看系统提供的时区信息","link":"#_2-1-查看系统提供的时区信息","children":[]}]},{"level":2,"title":"3. 同步硬件时间和系统时间","slug":"_3-同步硬件时间和系统时间","link":"#_3-同步硬件时间和系统时间","children":[]},{"level":2,"title":"4. 修改 ntp.conf 的配置","slug":"_4-修改-ntp-conf-的配置","link":"#_4-修改-ntp-conf-的配置","children":[]},{"level":2,"title":"5. 启动ntpd服务，并配置开机启动","slug":"_5-启动ntpd服务-并配置开机启动","link":"#_5-启动ntpd服务-并配置开机启动","children":[]},{"level":2,"title":"6. 查看ntp服务运行状况","slug":"_6-查看ntp服务运行状况","link":"#_6-查看ntp服务运行状况","children":[]}],"git":{"createdTime":1723779818000,"updatedTime":1737874162000,"contributors":[{"name":"Shawn Lyu","username":"Shawn Lyu","email":"shawnlyu1990@gmail.com","commits":7,"url":"https://github.com/Shawn Lyu"}]},"readingTime":{"minutes":9.3,"words":2791},"filePathRelative":"posts/Blogs/Linux/服务部署/2017-02-17-Fedora25部署服务-NTP.md","localizedDate":"2017年2月17日","excerpt":"","copyright":{"license":"MIT"},"autoDesc":true}');export{p as comp,d as data};
